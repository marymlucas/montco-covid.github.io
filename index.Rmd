---
title: "Montgomery County, PA - 911 Call Data and COVID-19 Analysis"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, include=FALSE}
library(tidyverse)
library(lubridate)
library(data.table) # need this for the "%like%"function
```

```{r, echo=FALSE}
tz_latest <- read.csv("https://storage.googleapis.com/montco-stats/tz.csv")
jhu_latest <- read.csv("https://raw.githubusercontent.com/CSSEGISandData/COVID-19/master/csse_covid_19_data/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")
```

```{r, echo=FALSE}
# data cleanup
tz_latest$datetime <- ymd_hms(tz_latest$timeStamp, tz=NULL)
tz_latest$desc <- as.character(tz_latest$desc)
tz_latest$zip <- as.character(tz_latest$zip)

```

## CALL TRENDS FROM 2015 TO PRESENT FOR SELECT COMPLAINTS

## 911 Calls for Fever
Very notable spike in calls at the beginning of 2020 compared to previous years

```{r, echo=FALSE}
tz_latest_fever <- tz_latest %>% filter(title == "EMS: FEVER") %>%
  group_by(month=floor_date(datetime, "month")) %>%
  tally(name = 'number_of_calls_fever') 

ggplot(tz_latest_fever, aes(x=as.Date(month), y=number_of_calls_fever)) +
  geom_line() + scale_x_date(date_labels = "%m-%Y", date_breaks = "2 months") +
  theme_minimal() +
  #labs(title = "911 Calls for Fever", subtitle = "Montgomery County, PA") +
  xlab("Month -Year") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```

## 911 Calls for Respiratory Emergencies
No noticeable spike here which is unexpected considering the initial understanding of SARS-CoV2 to be a respiratory virus

```{r, echo=FALSE}
# Calls for Respiratory Emergencies
tz_latest_resp <- tz_latest %>% filter(title == "EMS: RESPIRATORY EMERGENCY") %>%
  group_by(month=floor_date(datetime, "month")) %>%
  tally(name = 'number_of_calls_resp') 

ggplot(tz_latest_resp, aes(x=as.Date(month), y=number_of_calls_resp)) +
  geom_line() + scale_x_date(date_labels = "%m-%Y", date_breaks = "2 months") +
  theme_minimal() +
  #labs(title = "911 Calls for Respiratory Emergencies", subtitle = "Montgomery County, PA") +
  xlab("Month -Year") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```

## 911 Calls for Cardiac Emergencies
No noticeable spike here

```{r, echo=FALSE}
# Calls for Respiratory Emergencies
tz_latest_cardiac <- tz_latest %>% filter(title == "EMS: CARDIAC EMERGENCY") %>%
  group_by(month=floor_date(datetime, "month")) %>%
  tally(name = 'number_of_calls_cardiac') 

ggplot(tz_latest_cardiac, aes(x=as.Date(month), y=number_of_calls_cardiac)) +
  geom_line() + scale_x_date(date_labels = "%m-%Y", date_breaks = "2 months") +
  theme_minimal() +
  #labs(title = "911 Calls for Cardiac Emergencies", subtitle = "Montgomery County, PA") +
  xlab("Month -Year") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```

## 911 Calls for Medic Alert Alarms
A noticeable spike in medic alert alarms starting late 2019, may be completely unrelated but would be interesting to triangulate and see if most of these are from nursing home locations?

```{r, echo=FALSE}
# Calls for Medic Alert Alarms
tz_latest_medicalert <- tz_latest %>% filter(title == "EMS: MEDICAL ALERT ALARM") %>%
  group_by(month=floor_date(datetime, "month")) %>%
  tally(name = 'number_of_calls_medicalert') 

ggplot(tz_latest_medicalert, aes(x=as.Date(month), y=number_of_calls_medicalert)) +
  geom_line() + scale_x_date(date_labels = "%m-%Y", date_breaks = "2 months") +
  theme_minimal() +
  #labs(title = "911 Calls for Medic Alert Alarms", subtitle = "by month and year") +
  xlab("Month -Year") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```

## 911 Calls for Traffic-related incidents
A total drop off in 911 calls for traffic-related, likely a strong reflection of the quarantine measures, fewer people out and about.

```{r, echo=FALSE}
# Calls for traffic incidents
tz_latest_traffic <- tz_latest %>% filter(title %like% ("Traffic:")) %>%
  group_by(month=floor_date(datetime, "month")) %>%
  tally(name = 'number_of_calls_traffic') 

ggplot(tz_latest_traffic, aes(x=as.Date(month), y=number_of_calls_traffic)) +
  geom_line() + scale_x_date(date_labels = "%m-%Y", date_breaks = "2 months") +
  theme_minimal() +
  #labs(title = "911 Calls for Traffic Issues", subtitle = "by month and year") +
  xlab("Month -Year") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```


## SINCE START OF COVID-19
Narrowing down the focus on the data to just 2020, from around the presumed start of COVID-19 spread in the US

```{r, echo=FALSE}

# Extract 2020 call data for fever
tz_latest_fever_2020 <- tz_latest %>% filter(datetime>= "2020-01-01" & title == "EMS: FEVER") %>% group_by(week=floor_date(datetime, "week")) %>%
  tally(name = 'number_of_calls_fever_2020')  

ggplot(tz_latest_fever_2020, aes(x=as.Date(week), y=number_of_calls_fever_2020)) +
  geom_line() + scale_x_date(date_breaks = "2 weeks") +
  theme_minimal() +
  labs(title = "911 Calls for Fever", subtitle = "Montgomery County, PA") +
  xlab("Week") +
  ylab("Number of Calls") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```


```{r, echo=FALSE}
# Extract Covid-19 data for Montco PA only

montco_data <- jhu_latest %>% filter(Combined_Key == "Montgomery, Pennsylvania, US") %>%
  select(starts_with("X"))  
  
montco_data_cases <- montco_data %>% rbind(montco_data, as.vector(unlist(str_split(colnames(montco_data), " ")))) %>%
  t() %>%
  as_tibble(.name_repair = NULL) %>%
  mutate(date = str_sub(V3, 2)) %>%
  select(date, number_of_cases = V1) %>%
  mutate(date =  mdy(date), number_of_cases = as.numeric(number_of_cases)) %>%
  filter(wday(date) == 1) # to matchup with dates in the fevers table

ggplot(montco_data_cases, aes(x=as.Date(date), y=number_of_cases)) +
  geom_line() + scale_x_date(date_breaks = "2 weeks") +
  theme_minimal() +
  labs(title = "COVID-19 Confirmed Cases by Week", subtitle = "Montgomery County, PA (tuesdays") +
  xlab("Week") +
  ylab("Total Number of Cases") +
  theme(axis.text.x=element_text(angle=60, hjust=1))
```

## Comparing Calls for Fever with Confirmed Cases 
Exploring the correlation between number of calls for fever and number of confirmed cases we see a lag the trend for both which may be indicative of the delay between when COVID-19 may have started affecting people in the area vs when confirmation of diagnosis (not an individual basis but from a general big-picture perspective)
```{r, echo=FALSE}
#merge the two
tz_latest_fever_2020$week <- as.Date(tz_latest_fever_2020$week)
merged <- left_join(tz_latest_fever_2020, montco_data_cases, by = c("week" = "date"))
merged$number_of_cases[is.na(merged$number_of_cases)] <- 0
merged
```
```{r, echo=FALSE}
coeff <- 50

# A few constants
callsColor <- "#69b3a2"
casesColor <- rgb(0.2, 0.6, 0.9, 1)

ggplot(merged, aes(x=week)) +
  
  geom_line( aes(y=number_of_calls_fever_2020), color=callsColor) + 
  geom_line( aes(y=number_of_cases / coeff), color=casesColor) +
  
  scale_y_continuous(
    
    # Features of the first axis
    name = "Number of Calls",
    
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coeff, name="Total Confirmed Cases")
  ) + 

  theme(
    axis.title.y = element_text(color = callsColor, size=13),
    axis.title.y.right = element_text(color = casesColor, size=13)
  ) +

  labs(title = "Number of 911 Calls for Fever compared with Number of Confirmed Cases", subtitle = "Montgomery County, PA")
```
